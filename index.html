<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BACIR AI - الدردشة الفورية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Kufi+Arabic:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Noto Kufi Arabic', 'Inter', sans-serif;
        }
        /* تنسيقات شريط التمرير والكود */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        pre { background-color: #030712; color: #d1d5db; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; font-family: 'Courier New', Courier, monospace; direction: ltr; text-align: left; }
        code { font-family: 'Courier New', Courier, monospace; }
        /* لتنسيق الكود داخل النص */
        :not(pre) > code { background-color: #374151; color: #f3f4f6; padding: 2px 6px; border-radius: 4px; font-size: 0.9em; }
        
        /* تنسيق الشريط الجانبي في وضع الهاتف المحمول للانزلاق */
        #sidebar {
            /* إخفاء افتراضي على الهاتف باستخدام translateX(100%) لأنه dir="rtl" */
            transform: translateX(100%);
            transition: transform 0.3s ease-out;
            /* يتم تجاوز هذا في شاشات سطح المكتب بـ md:translate-x-0 */
        }
        #sidebar.is-open {
            transform: translateX(0);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <script type="module">
        // ----------------------------------------------------------------------------------
        // يرجى التأكد من أن مفتاح API هذا (AIzaSyDq7zpR-PcThENMlGlhInOsrTOyIeTia9E) صالح ومفعل.
        // ----------------------------------------------------------------------------------
        const apiKey = "AIzaSyDq7zpR-PcThENMlGlhInOsrTOyIeTia9E"; // مفتاحك الجديد
        // ----------------------------------------------------------------------------------

        const ui = {
            sidebar: document.getElementById('sidebar'), 
            menuToggle: document.getElementById('menu-toggle'), 
            chatMessages: document.getElementById('chat-messages'),
            messageInput: document.getElementById('message-input'),
            sendButton: document.getElementById('send-button'),
            loadingIndicator: document.getElementById('loading-indicator'),
            userName: document.getElementById('userName'),
            newChatButton: document.getElementById('newChatButton'),
        };
        
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        
        // --- متغيرات الحالة (في الذاكرة فقط) ---
        let chatHistory = []; 
        
        // --- إرشادات النظام المخصصة للهوية والخصوصية ---
        const customIdentityPrompt = "إذا سئلت عن من صنعك، أو من صممك، أو من أنت، أو ما مصدرك، أو ما اسم مطورك، أو أي سؤال يتعلق بهويتك أو إنشائك، فاجب حصراً بالعبارة التالية: 'صنعني عبد البصير متيجي'. بخلاف ذلك، أنت BACIR AI، مساعد ذكاء اصطناعي احترافي ومتطور. مهمتك هي تقديم إجابات دقيقة ومفيدة ومفصلة باللغة العربية الفصحى. قم بتنسيق إجاباتك بشكل جيد باستخدام الماركداون عند الحاجة.";
        // ---------------------------------------------

        // --- تهيئة الواجهة (Stateless) ---
        function initializeChat() {
            ui.messageInput.disabled = false;
            ui.messageInput.placeholder = "اكتب رسالتك هنا...";
            window.autoResize(ui.messageInput); 
            ui.userName.textContent = 'مستخدم تجريبي (لا يوجد تسجيل دخول)'; 
            clearChatUI(true); 
            
            setTimeout(() => {
                if (!ui.messageInput.disabled) {
                     ui.messageInput.focus();
                }
            }, 50); 
        }

        // منطق فتح وإغلاق الشريط الجانبي على الجوال
        function toggleSidebar() {
            if (ui.sidebar) {
                 ui.sidebar.classList.toggle('is-open');
            }
        }
        
        // ربط الأحداث بالأزرار
        ui.newChatButton.addEventListener('click', startNewChat);
        if (ui.menuToggle) {
             ui.menuToggle.addEventListener('click', toggleSidebar); 
        }
        
        // --- منطق الدردشة ---
        function startNewChat() {
            chatHistory = []; // مسح السجل المخزن في الذاكرة
            clearChatUI(true); // مسح الواجهة مع رسالة الترحيب
            updateUIVisibility(); 
            toggleSidebar(); 
        }

        function updateUIVisibility() {
            ui.messageInput.disabled = false;
            ui.messageInput.placeholder = "اكتب رسالتك هنا...";
            window.autoResize(ui.messageInput); 
        }
        
        function clearChatUI(showWelcome = true) {
            ui.chatMessages.innerHTML = '';
            if (showWelcome) {
                window.displayMessage("مرحباً بك في BACIR AI. كيف يمكنني مساعدتك اليوم؟ (ملاحظة: السجل يُمسح عند تحديث الصفحة.)", 'ai');
            }
        }

        // التحقق من وجود النص وحالة تحديث الزر
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
            
            const hasText = textarea.value.trim().length > 0;
            
            ui.sendButton.disabled = !hasText;
        }

        ui.messageInput.addEventListener('input', () => window.autoResize(ui.messageInput));
        ui.messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        ui.sendButton.addEventListener('click', sendMessage);

        async function sendMessage() {
            
            // **تشخيص: هل يتم تشغيل هذه الدالة؟**
            console.log("BACIR AI: Attempting to send message..."); 
            
            const prompt = ui.messageInput.value.trim();
            if (prompt.length === 0) {
                 console.warn("BACIR AI: Message input is empty after trimming. Blocking send.");
                 return;
            }

            window.displayMessage(prompt, 'user');
            ui.messageInput.value = '';
            window.autoResize(ui.messageInput);
            ui.sendButton.disabled = true; 
            ui.loadingIndicator.style.display = 'block';
            ui.messageInput.disabled = true; // تعطيل الإدخال أثناء المعالجة

            // إضافة رسالة المستخدم إلى السجل المؤقت (للحفاظ على السياق في هذا الطلب)
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            try {
                const aiResponse = await callGeminiAPI();
                
                // إضافة رد النموذج إلى السجل المؤقت
                chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                
                // عرض الرد النهائي
                window.displayMessage(aiResponse, 'model');

            } catch (error) {
                console.error("Error calling Gemini API:", error);
                // عرض رسالة خطأ واضحة في الواجهة
                window.displayMessage(`عذراً، حدث خطأ أثناء معالجة طلبك. يرجى مراجعة Console (F12) لمعرفة رمز الخطأ: ${error.message}`, 'ai', true);
            } finally {
                ui.loadingIndicator.style.display = 'none';
                ui.messageInput.disabled = false;
                window.autoResize(ui.messageInput); 
                ui.messageInput.focus();
            }
        }

        // --- دوال العرض والتعامل مع البيانات ---
        
        function displayMessage(message, sender, isError = false) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex items-start w-full max-w-5xl mx-auto mb-6 ${sender === 'user' ? 'ml-auto justify-start' : 'mr-auto justify-end'}`;

            const icon = document.createElement('span');
            icon.className = 'flex-shrink-0 flex items-center justify-center w-8 h-8 rounded-full text-lg shadow-md';

            const content = document.createElement('div');
            content.className = 'p-3 shadow-xl max-w-xl';

            if (sender === 'user') {
                icon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>`;
                icon.classList.add('bg-blue-600', 'text-white', 'order-2', 'mr-2'); 
                content.classList.add('bg-blue-600', 'text-white', 'order-1', 'rounded-xl', 'rounded-tl-none'); 
                content.innerHTML = `<p class="font-medium">${window.escapeHTML(message)}</p>`;
                
                messageWrapper.appendChild(content);
                messageWrapper.appendChild(icon);

            } else { 
                icon.innerHTML = 'ب';
                icon.classList.add('bg-gray-700', 'text-blue-400', 'font-bold', 'order-2', 'ml-2'); 
                content.classList.add('bg-gray-800', 'text-gray-200', 'order-1', 'rounded-xl', 'rounded-tr-none'); 
                
                let headerText = 'BACIR AI';
                if (isError) {
                     headerText = 'BACIR AI (خطأ)';
                     content.classList.add('text-red-400');
                }

                content.innerHTML = `<p class="font-semibold text-white mb-1">${headerText}</p><div class="prose prose-invert max-w-none">${window.simpleMarkdownParse(message)}</div>`;
                
                messageWrapper.appendChild(content);
                messageWrapper.appendChild(icon);
            }
            
            ui.chatMessages.appendChild(messageWrapper);
            ui.chatMessages.scrollTop = ui.chatMessages.scrollHeight;
        }


        // --- دوال مساعدة (تنسيق، اتصال) ---

        function simpleMarkdownParse(text) {
            let html = window.escapeHTML(text);
            html = html.replace(/```(\w*)\n([\s\S]*?)```/g, (match, lang, code) => `</p><pre><code class="language-${lang || ''}">${code}</code></pre><p>`);
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            html = html.replace(/\*\*([^\*]+)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/^\* (.*)$/gm, '<ul><li>$1</li></ul>');
            html = html.replace(/<\/ul><ul>/g, '');
            html = '<p>' + html.split('\n\n').join('</p><p>') + '</p>';
            html = html.replace(/<p>\s*<\/p>/g, '');
            html = html.replace(/<p><ul>/g, '<ul>');
            html = html.replace(/<\/ul><\/p>/g, '</ul>');
            return html;
        }
        
        function escapeHTML(str) {
            return str.replace(/[&<>"']/g, m => ({'&': '&amp;','<': '&lt;','>': '&gt;','"': '&quot;',"'": '&#39;'})[m]);
        }

        async function callGeminiAPI() {
            const payload = {
                contents: chatHistory, 
                systemInstruction: { parts: [{ text: customIdentityPrompt }] }, 
            };

            const response = await fetchWithBackoff(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });

            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(`API Error: ${response.status} ${response.statusText} - ${errorBody}`);
            }

            const result = await response.json();
            
            if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                return result.candidates[0].content.parts[0].text;
            } else {
                if (result.promptFeedback) {
                    console.error("Prompt blocked:", result.promptFeedback);
                    return "عذراً، تم حظر هذا الطلب بسبب سياسات الأمان.";
                }
                throw new Error("No content received from API");
            }
        }

        async function fetchWithBackoff(url, options, retries = 3, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if ((response.status === 429 || response.status === 503) && retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithBackoff(url, options, retries - 1, delay * 2);
                }
                return response;
            } catch (error) {
                if (retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithBackoff(url, options, retries - 1, delay * 2);
                }
                throw error;
            }
        }
        
        // ربط الدوال بالنطاق العام (window)
        window.autoResize = autoResize;
        window.displayMessage = displayMessage;
        window.escapeHTML = escapeHTML;
        window.simpleMarkdownParse = simpleMarkdownParse;
        
        // **بدء التطبيق تلقائياً**
        initializeChat();
    </script>

    <div class="flex h-screen">
        
        <aside id="sidebar" class="fixed inset-y-0 right-0 z-50 w-64 bg-gray-950 p-4 transform transition-transform duration-300 md:relative md:translate-x-0 md:flex md:flex-col">
            <div class="flex items-center justify-between mb-6">
                <span class="text-xl font-bold text-white">BACIR AI</span>
                <span class="flex items-center justify-center w-8 h-8 bg-blue-600 rounded-full text-white font-bold">ب</span>
            </div>
            
            <button id="newChatButton" class="w-full h-10 mb-6 bg-blue-600 text-white rounded-full font-semibold hover:bg-blue-700 transition-colors flex items-center justify-center text-xl" title="دردشة جديدة">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
            </button>

            <div class="flex-1 overflow-y-auto">
                <div class="p-2 bg-gray-800 rounded-lg text-xs text-gray-400 font-medium">
                    هذا التطبيق يعمل بدون حفظ سجل للمحادثات (Stateless). المحادثة تُحفظ في ذاكرة المتصفح فقط وتُمسح عند إغلاق أو إعادة تحميل الصفحة.
                </div>
            </div>

            <div class="mt-auto border-t border-gray-700 pt-4">
                <div class="flex items-center space-x-3 space-x-reverse text-gray-300 p-2 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <span id="userName" class="text-sm font-medium">مستخدم تجريبي</span>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-screen md:mr-64">
            
            <header class="md:hidden bg-gray-950 p-4 flex items-center justify-between border-b border-gray-800">
                <span class="flex items-center justify-center w-8 h-8 bg-blue-600 rounded-full text-white font-bold">ب</span>
                <span class="text-lg font-bold text-white">BACIR AI</span>
                <button id="menu-toggle" class="text-gray-200 p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16m-7 6h7" /></svg>
                </button>
            </header>

            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 md:p-10 space-y-4">
                </div>

            <div class="bg-gray-900 p-4 md:p-6 border-t border-gray-800">
                <div class="max-w-3xl mx-auto w-full relative">
                    <div id="loading-indicator" class="absolute bottom-16 right-1/2 translate-x-1/2 mb-2" style="display: none;">
                        <div class="flex items-center space-x-2 space-x-reverse bg-gray-700 px-3 py-1 rounded-full text-sm">
                            <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            <span>يفكر...</span>
                        </div>
                    </div>

                    <textarea
                        id="message-input"
                        rows="1"
                        class="w-full bg-gray-800 border border-gray-700 rounded-lg py-3 pr-4 pl-12 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none overflow-y-hidden"
                        placeholder="اكتب رسالتك هنا..."
                        oninput="autoResize(this)"
                    ></textarea>
                    <button id="send-button" class="absolute top-1/2 -translate-y-1/2 left-3 p-2 text-gray-400 hover:text-blue-500 transition-colors rounded-full focus:outline-none disabled:opacity-50" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 16.5V3.5a1 1 0 00.894-.947zM10 15.399l-5.143 1.468 6.143-12.286A1 1 0 0112 3.5v12.5a1 1 0 01-.894.947l-1.106.316z" /></svg>
                    </button>
                </div>
            </div>
        </main>
    </div>
</body>
</html>
